name: Performance Regression Tests
# Schedule triggers
on:
  # TODO THIS IS FOR DEV ONLY:
  pull_request:
  # runs twice a day at 10:05am and 10:05pm
  schedule:
    - cron: "5 10,22 * * *"
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  RUNNER_CACHE_PATH: performance/runner/target/release/runner

jobs:
  latest-runner:
    name: Build Runner or Use Cached
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-D warnings"
    steps:
      - name: DEBUG pwd
        run: pwd

      - name: DEBUG ls
        run: ls -lah

      - name: Checkout
        uses: actions/checkout@v2

      # attempts to access a previously cached runner
      - uses: actions/cache@v2
        id: cache
        with:
          path: ${{ env.RUNNER_CACHE_PATH }}
          key: ${{ runner.os }}-${{ hashFiles('performance/runner/Cargo.toml', 'performance/runner/src/*') }}

      - name: Fetch Rust Toolchain
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Add fmt
        if: steps.cache.outputs.cache-hit != 'true'
        run: rustup component add rustfmt

      - name: Cargo fmt
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --manifest-path performance/runner/Cargo.toml --all -- --check

      - name: Test
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --manifest-path performance/runner/Cargo.toml

      - name: Build (optimized)
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --manifest-path performance/runner/Cargo.toml
      # the cache action automatically caches this binary at the end of the job

  # run the performance measurements on the current or default branch
  measure-dev:
    needs: [latest-runner]
    name: Measure Dev Branch
    runs-on: ubuntu-latest
    steps:
      - name: checkout dev
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2.2.2
        with:
          python-version: "3.8"
      - name: install dbt
        run: pip install -r dev-requirements.txt -r editable-requirements.txt
      - name: install hyperfine
        run: wget https://github.com/sharkdp/hyperfine/releases/download/v1.11.0/hyperfine_1.11.0_amd64.deb && sudo dpkg -i hyperfine_1.11.0_amd64.deb
      # runner was just accessed or built so it should always be there
      - uses: actions/cache@v2
        id: cache
        with:
          path: ${{ env.RUNNER_CACHE_PATH }}
          key: ${{ runner.os }}-${{ hashFiles('performance/runner/Cargo.toml', 'performance/runner/src/*') }}

      - name: DEBUG ls
        run: ls -lah

      - name: DEBUG ls
        run: ls -lah performance/

      - name: DEBUG ls
        run: ls -lah performance/runner/

      - name: DEBUG ls
        run: ls -lah performance/runner/target/

      - name: DEBUG ls
        run: ls -lah performance/runner/target/release/

      - name: Move Runner
        run: mv performance/runner/target/release/runner ./

      - name: change permissions
        run: chmod +x ./runner
      - name: run
        run: ./runner measure -b dev -p ${{ github.workspace }}/performance/projects/
      - uses: actions/upload-artifact@v2
        with:
          name: dev-results
          path: performance/results/

  # run the performance measurements on the release branch which we use
  # as a performance baseline. This part takes by far the longest, so
  # we do everything we can first so the job fails fast.
  # -----
  # we need to checkout dbt twice in this job: once for the baseline dbt
  # version, and once to get the latest regression testing projects,
  # metrics, and runner code from the develop or current branch so that
  # the calculations match for both versions of dbt we are comparing.
  measure-baseline:
    needs: [latest-runner]
    name: Measure Baseline Branch
    runs-on: ubuntu-latest
    steps:
      - name: checkout latest
        uses: actions/checkout@v2
        with:
          ref: "0.20.latest"
      - name: Setup Python
        uses: actions/setup-python@v2.2.2
        with:
          python-version: "3.8"
      - name: move repo up a level
        run: mkdir ${{ github.workspace }}/../baseline/ && cp -r ${{ github.workspace }} ${{ github.workspace }}/../baseline
      - name: "[debug] ls new dbt location"
        run: ls ${{ github.workspace }}/../baseline/dbt/
      # installation creates egg-links so we have to preserve source
      - name: install dbt from new location
        run: cd ${{ github.workspace }}/../baseline/dbt/ && pip install -r dev-requirements.txt -r editable-requirements.txt
      # checkout the current branch to get all the target projects
      # this deletes the old checked out code which is why we had to copy before
      - name: checkout dev
        uses: actions/checkout@v2
      - name: install hyperfine
        run: wget https://github.com/sharkdp/hyperfine/releases/download/v1.11.0/hyperfine_1.11.0_amd64.deb && sudo dpkg -i hyperfine_1.11.0_amd64.deb

      # runner was just accessed or built so it should always be there
      - uses: actions/cache@v2
        id: cache
        with:
          path: ${{ env.RUNNER_CACHE_PATH }}
          key: ${{ runner.os }}-${{ hashFiles('performance/runner/Cargo.toml', 'performance/runner/src/*') }}

      - name: DEBUG ls
        run: ls -lah

      - name: DEBUG ls
        run: ls -lah performance/

      - name: DEBUG ls
        run: ls -lah performance/runner/

      - name: DEBUG ls
        run: ls -lah performance/runner/target/

      - name: DEBUG ls
        run: ls -lah performance/runner/target/release/

      - name: Move Runner
        run: mv performance/runner/target/release/runner ./

      - name: change permissions
        run: chmod +x ./runner
      - name: run runner
        run: ./runner measure -b baseline -p ${{ github.workspace }}/performance/projects/
      - uses: actions/upload-artifact@v2
        with:
          name: baseline-results
          path: performance/results/

  # detect regressions on the output generated from measuring
  # the two branches. Exits with non-zero code if a regression is detected.
  calculate-regressions:
    needs: [measure-dev, measure-baseline]
    name: Compare Results
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: dev-results
      - uses: actions/download-artifact@v2
        with:
          name: baseline-results
      - name: "[debug] ls result files"
        run: ls

      # runner was just accessed or built so it should always be there
      - uses: actions/cache@v2
        id: cache
        with:
          path: ${{ env.RUNNER_CACHE_PATH }}
          key: ${{ runner.os }}-${{ hashFiles('performance/runner/Cargo.toml', 'performance/runner/src/*') }}

      - name: change permissions
        run: chmod +x ./runner
      - name: make results directory
        run: mkdir ./final-output/
      - name: run calculation
        run: ./runner calculate -r ./ -o ./final-output/
        # always attempt to upload the results even if there were regressions found
      - uses: actions/upload-artifact@v2
        if: ${{ always() }}
        with:
          name: final-calculations
          path: ./final-output/*
