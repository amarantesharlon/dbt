# **what?**
# Checks that a file has been committed under the /.changes directory
# as a new CHANGELOG entry.  Cannot check for a specific filename as
# it is dynamically generated by change type and timestamp.
# This workflow should not require any secrets since it runs for PRs
# from forked repos.
# By default, secrets are not passed to workflows running from
# a forked repo.

# **why?**
# Ensure code change gets reflected in the CHANGELOG.

# **when?**
# This will run for all PRs going into main and *.latest.

name: Check Changelog Entry

on:
  push:
    branches:
      - "main"
      - "*.latest"
  pull_request:
  workflow_dispatch:

permissions: read-all

# will cancel previous workflows triggered by the same event and for the same ref for PRs or same SHA otherwise  (TODO: do I need this here?)
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ contains(github.event_name, 'pull_request') && github.event.pull_request.head.ref || github.sha }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  changelog:
    name: changelog

    runs-on: ubuntu-latest

    steps:
      - name: Run changed-files with defaults on .changes/unreleased
        id: changed-files-for-changes
        uses: tj-actions/changed-files@v15.1
        with:
          path: .changes/unreleased
      - name: Check for files that have been added to .changes/unreleased
        if: steps.changed-files-for-changes.outputs.added_files.any_changed != 'true'
        run:
          echo "stop run, no changelog exists" # TODO: post a comment about how to fix this similar to cla-bot?
